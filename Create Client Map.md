# Creating Client Map

## Creating new project 

A 'project' is a set of sites, with their site data, and related settings, that a User is authorised to view, once signed in. The map tiles are hosted on Mapbox. Optionally, it can show/hide specified layers, and display repeat-visit related data.

A project consists of the following Mapbox entities:

- Mapbox **Tileset** containing the map data (uploaded  .shp, or geojson, to Mapbox studio )
- Mapbox **Style** created or edited from within Mapbox Studio, providing symbology needed to render the mapdata.
- Mapbox **dataset** containing a set of named polygons, showing the bounds of individual sites included in the project. The list of site names is used to populate site search (need to check if this is correct).

### Create new Firebase user 

- Log into Fb (Firebase) dashboard
- Fb> Authentication > Add User 
- Provide an email (can be a fake email)
- Set a password (passwords currently are managed on FB Admin only, by ORCL, - ie user cannot change/control password)

NOTE- Ability to create new FB User will be added to Create MapboxUserPRofile form (User's UID is passed into Form, and used as key for the Ob, when It's created on FB).

### Create mapbox user Profile

Currently this is a manual process of creating and importing a json object. An existing user Json object can be exported and used as a template. 

It is proposed that this manual process is replaced with a new page on MapAdmin Dashboard, containing a form, that upon submission, uploads the object to FB.

#### User JSON object

Structure of the FB Json Object, showing fields and a brief description:

**WriteMaps** : bool, default: false,

**center** : number, default: {
     "lat" : 51.5079511,
    "lng" : -0.0616554
  },

**clickableLayers**, Array of strings . Optional. Defualt: null. eg[ "lines-wall", "lines-fence", "lines-fence-over-wall", "lines-path", "lines-gate", "lines-all-other", "points-symbol", "polygons", "veglayer" ]
Can leave blank ""[]") These are all the layers that are interactive for the webmap user, ie clickable features

**fbStoragePhotosPath**", Str. Optional. Default: null/blank. eg"blogsclientpath/320x240",

**hasRelatedData**,  default: false,

**mapboxAccessToken**, Str. eg"pk.eyJ1IjoiZGFuc2ltbW9ucyIsImEiOiJjamRsieTEwYmxn",
Preferably create a new token in Mapbox, or can share a token, or the default public token

**mapboxDataSource**, Str. eg "blogsclient-withTrees-sites--b3san6"
This is the mapbox tileset name, which is asigned by mapbox once the mapdata has been uploaded. (Is this optional? come back to. Can leave blank)

 **mapboxMapName** , Str. Optional? , default: null/blank. "Bloggs Client parks", - CBT - needed??

 **mapboxSitesDataSet**, Str."cka5g9ktt00rl2ose01b35"
(OPTIONAL) This is the ID of the datset of sites polygons, labled with site names. The ID is auto generated by Mapbox upon upload. Note that this data is not consumed in tiles, it a single block of data downloaded all at once, so be aware of storage limitations on client device.

 **mapboxStyleId**, Str. default: null. "mapbox://styles/hgfhgf/ck30cjvumxvkl2z"
This is url automatically generated upon style creation. This holds all the rendered map data as well as the map style

**optionalLayers**, [ {
    "label" : "Trees",
    "layerName" : "veglayer"
  }, {
    "label" : "satellite view",
    "layerName" : "mapbox-satellite"
  } ]
(OPTIONAL). Optional layers' is an array of layers that is the source of the list of site names that appears in the map's webpage. Layername needs to match the Mapbox style layer name. Label is the name that appears in the webpage. Implemented as dropdown box

**projectId**, Str.  "Ldo3edMKQr4lkcv7"
(OPTIONAL?). Come back to - when is this needed??

**projectinformation**", Str. default: null. eg  <p> This map shows all parks and open spaces managed by the borough html markup etc)</p>"
(OPTIONAL) This is the HTML content that appears in Webpage 'About' section

**userName**, Str. Default: null. Name that appears on Welcome screen in ClientMap eg Borough Name / client Name

**writeRelatedData**, Bool. default: false,

**zoom**, Number (int). Default: 11. Mapbox map zoom level

### Mapbox new project setup

- Login to Mapbox 'Studio'

- Create a new mapbox public key (make a note of this, as it will be needed for FBUser profile), and label it such that it can be associated with the project name. (If an existing client is creating a new project then could use their existing key).
-  This should be for ALL the data for all the sites in the project. Data can be uploaded from shp file in a zip. One zip per geometry type. (ie separate zips for Points, lines and polygons. Mapbox uses [epsg.io/3857](https://epsg.io/3857).
  If there are problems with the shp file, or if shp needs reprojection/coordinate conversion,  import using this procedure [convert shp using QGIS](https://github.com/Tootman/ORCL-webApp-docs/blob/master/ORCL%20WebMap%20Apps%20workflow.md#update-mapbox-mapdata-from-updated-shp-files). 

#### Upload site names 

(optional)

- Upload a **dataset** consisting of set of sites polygons with site name field



## Example setup

Using dataset GiGL_POPS_Shp.zip

#### Uploading the TileSet

1. Separate GiGL_POPS into 2 zip files, one for points and other for regions (polygon), delete 'MAC' folder
2. Upload points Zip. Note the assigned tileset ID eg dansimmons.1lxbihrc
3. Upload polygons zip. Note assigned tileset eg id: dansimmons.aesejvqy
4. Create a new style by copying an existing template then modifying as necessary
   Rename style as necessary

#### Creating the User JSON ojbect (Manual method*)

NOTE BE VARY CAREFULl - pressing wrong button in firebase could cause irrecoverable damage to the database

1. Export Towerhamlets Json object and open on a text editor,
2. Save as {projname}.json
3. Edit [JSON object properties as in example](#User-JSON-object) and resave etc
4. Go to FB dashboard and open the 'Users' node on Realtime database
5. (Optional but advisable - download/Export Users node as a backup incase of accidental deletaion/corruption )
6. Click  'Add child' ''+'' icon , which is next to the grey 'Users' label at top of object tree view
7. paste in User UID (look in FB Authentication > users >userUID), into 'Name' input box
8. type 'placeholder' into value text field, then 'enter' to update the FB DB
9. select the newly created child then click 3dots (top right ) > IMPORT
10. Select the newly renamed json file and import

 

*manual-method

Plan to replace this with partially automated webForm. Spec for form:



### Creating Point symbol 

Sprites in the sprite sheet used the Point symbols, can be created from scratch, or edit existing sprites.

- Sprites can be created /edited in a vector graphics program such as [inkscape.org](https://inkscape.org/) or [Figma](https://www.figma.com/) and imported as svg, to replace an existing sprite in the sprite sheet.

## Update existing Client map

**NOTE limit of 30 uploads per month** on free Mapbox tier

1. Login to Mapbox Studio
2. Import shp file (as ZIP etc) as a new Tileset
3. Navigate to the Client's style. The style name used can be found from inspecting the client's FB User Object, if necessary.
4. Replace the layer sources as necessary.  Several layers may use the same source (eg fence, gate, wall, path all use  lines source )
5. re-publish the map (It may take up to an hour for the server to refresh the served data )



