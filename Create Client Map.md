# Creating Client Map

## Creating new project 

A 'project' is a set of sites, with their site data, and related settings, that a User is authorised to view, once signed in. The map tiles are hosted on Mapbox. Optionally, it can show/hide specified layers, and display repeat-visit related data.

A project consists of the following Mapbox entities:

- mapbox **Tileset** containing the map data (uploaded  .shp, or geojson, to Mapbox studio )
- Mapbox **Style** created or edited from within Mapbox Studio, providing symbology needed to render the mapdata.
- Mapbox **dataset** containing a set of named polygons, showing the bounds of individual sites included in the project. The list of site names is used to populate site search (need to check if this is correct).

### Create new user 

- Log into Fb dashboard
- Fb> Authentication > Add User 
- Provide an email (can be a fake email)
- Set a password (passwords currently are managed on FB Admin only, by ORCL, - ie user cannot change/control password)
- 

### Create mapbox user Profile

Currently this is a manual process of creating and importing a json object. An existing user Json object can be exported and used as a template. 

It is proposed that this manual process is replaced with a new page on MapAdmin Dashboard, containing a form, that upon submission, uploads the object to FB.

#### User JSON object

Structure of the FB Json Object, showing fields and a brief description:

**WriteMaps** : false,
**center** : {
    "lat" : 51.5079511,
    "lng" : -0.0616554
  },

**clickableLayers** : [ "lines-wall", "lines-fence", "lines-fence-over-wall", "lines-path", "lines-gate", "lines-all-other", "points-symbol", "polygons", "veglayer" ]
(OPTIONAL, can leave blank ""[]") These are all the layers that are interactive for the webmap user, ie clickable features

**fbStoragePhotosPath**" : "blogsclientpath/320x240",

(OPTIONAL), can leave blank ie ""

**hasRelatedData** : false,

**mapboxAccessToken** : "pk.eyJ1IjoiZGFuc2ltbW9ucyIsImEiOiJjamRsieTEwYmxn",
Preferably create a new token in Mapbox, or can share a token, or the default public token

**mapboxDataSource** : "blogsclient-withTrees-sites--b3san6"
This is the mapbox tileset name, which is asigned by mapbox once the mapdata has been uploaded. (Is this optional? come back to. Can leave blank)

 **mapboxMapName** : "Bloggs Client parks",
 **mapboxSitesDataSet** : "cka5g9ktt00rl2ose01b35"
(OPTIONAL) This is the ID of the datset of sites polygons, labled with site names. The ID is auto generated by Mapbox upon upload. Note that this data is not consumed in tiles, it a single block of data downloaded all at once, so be aware of storage limitations on client device.

 **mapboxStyleId** : "mapbox://styles/hgfhgf/ck30cjvumxvkl2z"
This is url automatically generated upon style creation. This holds all the rendered map data as well as the map style

**optionalLayers** : [ {
    "label" : "Trees",
    "layerName" : "veglayer"
  }, {
    "label" : "satellite view",
    "layerName" : "mapbox-satellite"
  } ]
(OPTIONAL). Optional layers' is an array of layers that is the source of the list of site names that appears in the map's webpage. Layername needs to match the Mapbox style layer name. Label is the name that appears in the webpage.

**projectId**: "Ldo3edMKQr4lkcv7"
(OPTIONAL). Come back to - when is this needed??

**projectinformation** : "<p> This map shows all parks and open spaces managed by the borough html markup etc)</p>"
(OPTIONAL) This is the HTML content that appears in Webpage 'About' section

**userName** : "TowerHamlets",
Name that appears on Welcome screen in ClientMap

**writeRelatedData** : false,
 **zoom** : 11 mapbox map zoom level



### Mapbox new project setup

- Login to Mapbox 'Studio'

- Create a new mapbox public key (make a note of this, as it will be needed for FBUser profile), and label it such that it can be associated with the project name.
-  This should be for ALL the data for all the sites in the project. Data can be uploaded from shp file in a zip. One zip per geometry type. (ie seperate zips for Points, lines and polygons.
  If there are problems with the shp file import try using this procedure [convert shp using QGIS](https://github.com/Tootman/ORCL-webApp-docs/blob/master/ORCL%20WebMap%20Apps%20workflow.md#update-mapbox-mapdata-from-updated-shp-files). 

### create a 

#### Applying a style

- Use an existing 

#### Upload site names

- Upload a **dataset** consisting of set of sites polygons with site name field

### Notes

FB = Firebase

### Example setup

Using dataset GiGL_POPS_Shp.zip

#### Uploading the TileSet

1. Separate GiGL_POPS into 2 zip files, one for points and other for regions (polygon), delete 'MAC' folder
2. Upload points Zip. Note the assigned tileset ID eg dansimmons.1lxbihrc
3. Upload polygons zip. Note assigned tileset eg id: dansimmons.aesejvqy
4. Create a new style by copying an existing template then modifying as necessary
   Rename style as necessary

#### Creating the User JSON ojbect (Manual method*)

NOTE BE VARY CAREFULl - pressing wrong button in firebase could cause irrecoverable damage to the database

1. Export Towerhamlets Json object and open on a text editor,
2. Save as {projname}.json
3. Edit [JSON object properties as in example](#User-JSON-object) and resave etc
4. Go to FB dashboard and open the 'Users' node on Realtime database
5. (Optional but advisable - download/Export Users node as a backup incase of accidental deletaion/corruption )
6. Click  'Add child' ''+'' icon , which is next to the grey 'Users' label at top of object tree view
7. paste in User UID (look in FB Authentication > users >userUID), into 'Name' input box
8. type 'placeholder' into value text field, then 'enter' to update the FB DB
9. select the newly created child then click 3dots (top right ) > IMPORT
10. Select the newly renamed json file and import

 

*manual-method

Plan to replace this with partially automated webForm. Spec for form:







